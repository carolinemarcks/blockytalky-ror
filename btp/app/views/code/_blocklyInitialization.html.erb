<xml id="toolbox" style="display: none">
<category name="Start">
    <category name="Core">
        <category name="Control">
            <block type="controls_if"></block>
            <block type="controls_whileUntil"></block>
        </category>
        <category name="Logic">
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
            <block type="logic_boolean"></block>
        </category>
    </category>
    <category name="Custom">
        <block type="start"></block>
        <category name="Sensors">
            <block type="sensor_touch"></block>
            <block type="sensor_light"></block>
            <block type="sensor_ultrasonic"></block>
            <block type="sensor_sound"></block>
            <block type="sensor_new_val"></block>
        </category>
        <category name="Motors">
            <block type="motor_set"></block>
            <block type="motor_get_encoder"></block>
        </category>
        <category name="Pins">
            <block type="pin_in"></block>
            <block type="pin_out"></block>
        </category>
    </category>
</category>
</xml>

<script type="text/javascript">
    var hasInit = false; 
  function doBlocklyInitialize(){
        if(hasInit){return;}
        hasInit = true;
        var toolbox = '<xml>';
        toolbox += '  <block type="controls_if"></block>';
        toolbox += '  <block type="controls_whileUntil"></block>';
        Blockly.inject(document.getElementById('blocklyDiv'),
                       {path: '/blockly/',scrollbars:false, toolbox: document.getElementById('toolbox')});
        // Ugly stuff that needs to be replaced in the future
        document.getElementById('blocklyDiv').children[0].style = 'display: block; height: 351px;';
        <% if(@code.codetext) %>
            var code =  <%= ("'" + @code.codetext + "'").html_safe %> ;
            var xml_text = Blockly.Xml.textToDom(code);
            //XSS IS A FACTOR NOW AAAAA
            Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml_text);
        <% end %>
    }
    $(document).ready(doBlocklyInitialize);
</script>
